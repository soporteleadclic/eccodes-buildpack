#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2

echo "-----> Installing cmake"

# change to the the BUILD_DIR ($1)
cd $1

# download
curl https://s3.amazonaws.com/mergeguard/cmake.tar.gz -s -O

# make dir
mkdir -p /tmp/codon/vendor

# untar the binary to the directory we want
tar -C /tmp/codon/vendor -xvf cmake.tar.gz

debug=`ls /tmp/codon/vendor/bin`
echo $debug

export PATH=$PATH:/tmp/codon/vendor/bin

####

echo ""
echo "-----> Installing grib"


mkdir -p $CACHE_DIR/ecCodes
cd $CACHE_DIR/ecCodes

# install it
curl 'https://software.ecmwf.int/wiki/download/attachments/45757960/eccodes-2.6.0-Source.tar.gz?api=v2' > grib.tar.gz
mkdir grib
tar -xzf grib.tar.gz -C grib --strip-components 1
rm grib.tar.gz
mkdir build
cd build
cmake ../grib -DCMAKE_INSTALL_PREFIX=$CACHE_DIR/ecCodes
make && ctest && make install
cd ..

# add it to the PATH and build dir
mkdir -p $BUILD_DIR/ecCodes
cp -r $CACHE_DIR/ecCodes $BUILD_DIR

export PATH=$PATH:$BUILD_DIR/ecCodes/bin

BUILDPACK_DIR="$(dirname $(dirname $0))"
mkdir -p $BUILD_DIR/.profile.d
cp "$BUILDPACK_DIR/bin/set-path.sh" $BUILD_DIR/.profile.d/
chmod +x $BUILD_DIR/.profile.d/set-path.sh


echo "-----> Installed GRIB API v$(grib_info -v)"